<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <title>Ù…Ù†ØµØ© Ø§Ù„Ù‚Ø§Ø¦Ø¯ - Ù†Ø¸Ø§Ù… Ø§Ù„Ù…ØªØ§Ø¨Ø¹Ø© Ø§Ù„Ø°ÙƒÙŠ</title>
    <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;700&display=swap" rel="stylesheet">
    <style>
        :root { --primary: #1e3a5f; --accent: #e67e22; --success: #25d366; --bg: #f4f7f6; }
        * { font-family: 'Tajawal', sans-serif !important; box-sizing: border-box; }
        body { background: var(--bg); margin: 0; padding: 20px; color: #333; }
        .header { background: var(--primary); color: white; padding: 20px; border-radius: 12px; text-align: center; margin-bottom: 20px; }
        .upload-area { background: white; padding: 30px; border-radius: 15px; border: 3px dashed var(--primary); text-align: center; margin-bottom: 20px; }
        .status-bar { display: flex; justify-content: space-between; align-items: center; background: white; padding: 15px; border-radius: 10px; margin-bottom: 20px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); border-right: 5px solid var(--accent); }
        .controls { background: #fff; padding: 15px; border-radius: 10px; margin-bottom: 20px; display: flex; gap: 10px; align-items: center; border: 1px solid #ddd; }
        table { width: 100%; border-collapse: collapse; background: white; border-radius: 12px; overflow: hidden; }
        th { background: #f1f4f6; padding: 15px; border-bottom: 2px solid #eee; }
        td { padding: 12px; border-bottom: 1px solid #eee; text-align: center; }
        .btn { border: none; padding: 8px 15px; border-radius: 5px; cursor: pointer; font-weight: bold; }
        .wa-btn { background: var(--success); color: white; text-decoration: none; font-size: 0.85rem; display: inline-block; }
        .sim-btn { background: #8e44ad; color: white; }
        .reset-btn { background: #e74c3c; color: white; }
        .real-btn { background: #2c3e50; color: white; }
        .badge { background: var(--accent); color: white; padding: 4px 10px; border-radius: 15px; font-size: 0.9rem; }
        .hidden { display: none; }
        .error-log { color: red; margin-top: 10px; font-size: 0.8rem; }
    </style>
</head>
<body>

<div class="header">
    <h2 style="margin:0;">ğŸ“ Ù…Ù†ØµØ© Ø§Ù„Ù‚Ø§Ø¦Ø¯ Ø§Ù„Ø°ÙƒÙŠØ©</h2>
</div>

<div id="uploadContainer" class="upload-area">
    <h3>ÙŠØ±Ø¬Ù‰ Ø±ÙØ¹ Ù…Ù„Ù Ø§Ù„Ø¬Ø¯ÙˆÙ„ (time1.xml)</h3>
    <input type="file" id="xmlInput" accept=".xml" onchange="processAndSave(this)">
    <p>Ø³ÙŠØªÙ… Ø­ÙØ¸ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ÙÙŠ Ù…ØªØµÙØ­Ùƒ Ø¨Ø´ÙƒÙ„ Ø¯Ø§Ø¦Ù…</p>
    <div id="log" class="error-log"></div>
</div>

<div id="dashboard" class="hidden">
    <div class="controls">
        <strong>âš™ï¸ Ø£Ø¯ÙˆØ§Øª Ø§Ù„ÙØ­Øµ:</strong>
        <button class="btn sim-btn" onclick="activateSimulation()">ğŸ² ØªØ´ØºÙŠÙ„ Ø§Ù„Ù…Ø­Ø§ÙƒØ§Ø©</button>
        <button class="btn real-btn" onclick="activateRealTime()">â±ï¸ Ø§Ù„ÙˆÙ‚Øª Ø§Ù„ÙØ¹Ù„ÙŠ</button>
        <button class="btn reset-btn" onclick="clearMemory()" style="margin-right: auto;">ğŸ—‘ï¸ ØªØºÙŠÙŠØ± Ø§Ù„Ù…Ù„Ù</button>
    </div>

    <div class="status-bar">
        <div id="info">--</div>
        <div id="txtPeriod" style="font-weight: bold; color: var(--accent);">--</div>
        <div id="modeTag" style="padding: 5px 10px; border-radius: 5px; background: #ecf0f1;">Ø§Ù„ÙˆÙ‚Øª Ø§Ù„ÙØ¹Ù„ÙŠ</div>
    </div>

    <table>
        <thead>
            <tr>
                <th>Ø§Ù„ØµÙ</th>
                <th>Ø§Ù„Ù…Ø¹Ù„Ù…</th>
                <th>Ø§Ù„Ù…Ø§Ø¯Ø©</th>
                <th>ØªÙˆØ§ØµÙ„ ÙˆØ§ØªØ³Ø§Ø¨</th>
            </tr>
        </thead>
        <tbody id="tableBody"></tbody>
    </table>
</div>

<script>
// Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø¹Ù„Ù…ÙŠÙ† ÙƒÙ…Ø§ ØªÙ… Ø§Ø³ØªØ®Ø±Ø§Ø¬Ù‡Ø§ Ù…Ù† Ù…Ù„ÙØ§ØªÙƒ
const teacherDirectory = {
    "Ø£Ø­Ù…Ø¯ Ø§Ù„Ø¨Ù„ÙˆØ´ÙŠ": "96892959789", "Ø£Ø­Ù…Ø¯ Ø¹Ø¨Ø¯Ø§Ù„ÙˆÙ‡Ø§Ø¨": "96890128035", "Ø£Ø­Ù…Ø¯ Ø¹ÙŠØ³Ù‰ Ø¬Ù…Ø¹Ù‡ Ø§Ù„Ø¨ÙˆØµØ§ÙÙŠ": "96892876386",
    "Ø§Ø­Ù…Ø¯ Ø³Ø§Ù„Ù… Ù…Ø­Ù…Ø¯ Ø§Ù„ØºÙ…Ø§Ø±Ù‰": "96895500478", "Ø§Ø­Ù…Ø¯ Ø¹Ø¨Ø¯Ø§Ù„ØªÙˆØ§Ø¨": "96876609518", "Ø§Ø­Ù…Ø¯ Ù…Ø­Ù…Ø¯ Ø¬Ù…Ø¹Ù‡ Ø§Ù„Ø¨ÙˆØµØ§ÙÙ‰": "96892923979",
    "Ø§ÙŠÙ‡Ø§Ø¨ Ø¹Ù„ÙŠ Ù…Ø­Ù…Ø¯ Ø§Ù„Ø³ÙŠØ¯": "96891606092", "Ø¨Ù„Ø¹Ø±Ø¨": "96897366148", "Ø­Ø§Ø±Ø« Ù…Ø­Ù…Ø¯ Ø§Ø­Ù…Ø¯ Ø§Ù„Ø¨Ø·Ø§Ø´Ù‰": "96893355596",
    "Ø­Ù…Ø¯ Ø§Ù„Ù…Ø´Ø±ÙÙŠ": "96890918714", "Ø®Ø§Ù„Ø¯ Ø§Ù„Ø¹Ù„ÙˆÙŠ": "96896326333", "Ø®Ø§Ù„Ø¯ Ø±Ø§Ø´Ø¯ Ø³Ø¹ÙŠØ¯ Ø§Ù„ØºÙ…Ø§Ø±Ù‰": "96899857755",
    "Ø±Ø§Ø´Ø¯ Ù†Ø§ØµØ± Ø±Ø§Ø´Ø¯ Ø§Ù„ÙˆÙ‡ÙŠØ¨Ù‰": "96899211393", "Ø³Ø§Ù„Ù… Ø®Ù…ÙŠØ³ Ø¬Ù…Ø¹Ù‡ Ø§Ù„Ø²Ù‡ÙŠÙ…Ù‰": "96899322745", "Ø³ÙŠÙ Ø§Ø­Ù…Ø¯ Ø³ÙŠÙ Ø§Ù„Ø¨Ø·Ø§Ø´Ù‰": "96898920818",
    "Ø³ Ø±ÙŠØ§Ø¶ÙŠØ§Øª": "96876609518", "ÙˆØ³ Ø±ÙŠØ§Ø¶ÙŠØ§Øª": "96876609518"
};

let db = { teachers: {}, classes: {}, subjects: {}, lessons: [], periods: [] };
let simulationActive = false;
let simDay, simTime;

window.onload = function() {
    const saved = localStorage.getItem('schoolTableData');
    if (saved) { 
        try {
            db = JSON.parse(saved); 
            showDashboard(); 
        } catch(e) {
            console.error("Ø®Ø·Ø£ ÙÙŠ Ù‚Ø±Ø§Ø¡Ø© Ø§Ù„Ø°Ø§ÙƒØ±Ø©");
        }
    }
};

function processAndSave(input) {
    const logDiv = document.getElementById('log');
    if (!input.files[0]) return;
    
    logDiv.innerText = "Ø¬Ø§Ø±ÙŠ Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„Ù…Ù„Ù...";
    const reader = new FileReader();
    
    // Ù…Ø­Ø§ÙˆÙ„Ø© Ø§Ù„Ù‚Ø±Ø§Ø¡Ø© Ø¨ØªØ±Ù…ÙŠØ² windows-1256 Ø§Ù„Ù…Ù†Ø§Ø³Ø¨ Ù„Ù…Ù„ÙØ§Øª Ø¹Ù…Ø§Ù† XML
    reader.readAsText(input.files[0], "windows-1256");
    
    reader.onload = function(e) {
        try {
            const xmlText = e.target.result;
            const parser = new DOMParser();
            const xml = parser.parseFromString(xmlText, "text/xml");
            
            // ÙØ­Øµ Ø¥Ø°Ø§ ÙƒØ§Ù† Ø§Ù„Ù…Ù„Ù XML ØµØ§Ù„Ø­Ø§Ù‹
            if (xml.getElementsByTagName("parsererror").length > 0) {
                throw new Error("ØªÙ†Ø³ÙŠÙ‚ Ù…Ù„Ù XML ØºÙŠØ± ØµØ§Ù„Ø­");
            }

            // ØªØµÙÙŠØ± Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù‚Ø¯ÙŠÙ…Ø© Ù‚Ø¨Ù„ Ø§Ù„ØªØ¹Ø¨Ø¦Ø©
            db = { teachers: {}, classes: {}, subjects: {}, lessons: [], periods: [] };

            // Ø§Ø³ØªØ®Ø±Ø§Ø¬ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
            const teachers = xml.getElementsByTagName('teacher');
            for(let t of teachers) db.teachers[t.getAttribute('id')] = t.getAttribute('name');

            const classes = xml.getElementsByTagName('class');
            for(let c of classes) db.classes[c.getAttribute('id')] = c.getAttribute('short');

            const subjects = xml.getElementsByTagName('subject');
            for(let s of subjects) db.subjects[s.getAttribute('id')] = s.getAttribute('name');

            const periods = xml.getElementsByTagName('period');
            for(let p of periods) db.periods.push({
                id: p.getAttribute('period'), 
                s: p.getAttribute('starttime'), 
                e: p.getAttribute('endtime')
            });

            const schedules = xml.getElementsByTagName('TimeTableSchedule');
            for(let l of schedules) {
                db.lessons.push({
                    d: l.getAttribute('DayID'), 
                    p: l.getAttribute('Period'), 
                    c: l.getAttribute('ClassID'), 
                    t: l.getAttribute('TeacherID'), 
                    s: l.getAttribute('SubjectGradeID')
                });
            }

            if (db.lessons.length === 0) throw new Error("Ø§Ù„Ù…Ù„Ù Ù„Ø§ ÙŠØ­ØªÙˆÙŠ Ø¹Ù„Ù‰ Ø­ØµØµ Ù…Ø¬Ø¯ÙˆÙ„Ø©");

            localStorage.setItem('schoolTableData', JSON.stringify(db));
            showDashboard();
            logDiv.innerText = "";
        } catch (error) {
            logDiv.innerText = "Ø®Ø·Ø£: " + error.message;
            console.error(error);
        }
    };
}

function showDashboard() {
    document.getElementById('uploadContainer').classList.add('hidden');
    document.getElementById('dashboard').classList.remove('hidden');
    update();
    setInterval(update, 10000);
}

function activateSimulation() {
    simulationActive = true;
    simDay = Math.floor(Math.random() * 5) + 1;
    if (db.periods.length > 0) {
        const randomPeriod = db.periods[Math.floor(Math.random() * db.periods.length)];
        simTime = randomPeriod.s;
    }
    update();
}

function activateRealTime() {
    simulationActive = false;
    update();
}

function clearMemory() {
    if(confirm("Ø³ÙŠØªÙ… Ø­Ø°Ù Ø§Ù„Ø¨ÙŠØ§Ù†Ø§ØªØŒ Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ØŸ")) {
        localStorage.removeItem('schoolTableData');
        location.reload();
    }
}

function update() {
    const now = new Date();
    const daysArr = ["Ø§Ù„Ø£Ø­Ø¯", "Ø§Ù„Ø¥Ø«Ù†ÙŠÙ†", "Ø§Ù„Ø«Ù„Ø§Ø«Ø§Ø¡", "Ø§Ù„Ø£Ø±Ø¨Ø¹Ø§Ø¡", "Ø§Ù„Ø®Ù…ÙŠØ³", "Ø§Ù„Ø¬Ù…Ø¹Ø©", "Ø§Ù„Ø³Ø¨Øª"];
    
    let dayForLogic = simulationActive ? simDay : (now.getDay() === 0 ? 1 : now.getDay() + 1);
    let timeForLogic = simulationActive ? simTime : now.getHours() + ":" + now.getMinutes().toString().padStart(2, '0');
    
    document.getElementById('info').innerText = daysArr[simulationActive ? (simDay==1?0:simDay-1) : now.getDay()] + " | " + timeForLogic;

    const p = db.periods.find(p => { 
        const cur = toMin(timeForLogic), s = toMin(p.s), e = toMin(p.e); 
        return cur >= s && cur <= e; 
    });

    const tbody = document.getElementById('tableBody');
    if (p) {
        document.getElementById('txtPeriod').innerText = "Ø§Ù„Ø­ØµØ©: " + p.id;
        const current = db.lessons.filter(l => l.d == dayForLogic && l.p == p.id)
            .sort((a, b) => (db.classes[a.c] || "").localeCompare(db.classes[b.c] || "", 'ar', {numeric: true}));
        
        tbody.innerHTML = current.map(l => {
            let name = db.teachers[l.t] || "ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ";
            let className = db.classes[l.c] || "---";
            let subjectName = db.subjects[l.s] || "---";
            let phone = teacherDirectory[name] || "";
            let chatName = (name === "Ø³ Ø±ÙŠØ§Ø¶ÙŠØ§Øª" || name === "ÙˆØ³ Ø±ÙŠØ§Ø¶ÙŠØ§Øª") ? "Ø£Ø­Ù…Ø¯ Ø¹Ø¨Ø¯Ø§Ù„ØªÙˆØ§Ø¨" : name;

            let msg = `Ø§Ù„Ø£Ø³ØªØ§Ø°/ ${chatName}\nÙ†Ø°ÙƒØ±ÙƒÙ… Ø¨Ø­ØµØªÙƒÙ…:\n- Ø§Ù„Ø­ØµØ©: (${p.id})\n- Ø§Ù„ØµÙ: (${className})\n- Ø§Ù„Ù…Ø§Ø¯Ø©: (${subjectName})`;

            return `<tr>
                <td><span class="badge">${className}</span></td>
                <td><b>${name}</b></td>
                <td>${subjectName}</td>
                <td>${phone ? `<a href="https://wa.me/${phone}?text=${encodeURIComponent(msg)}" target="_blank" class="wa-btn btn">ğŸ“² Ù…Ø±Ø§Ø³Ù„Ø©</a>` : '---'}</td>
            </tr>`;
        }).join('');
    } else {
        document.getElementById('txtPeriod').innerText = "Ø®Ø§Ø±Ø¬ Ø§Ù„Ø¯ÙˆØ§Ù…";
        tbody.innerHTML = "<tr><td colspan='4' style='padding:40px'>Ù„Ø§ ØªÙˆØ¬Ø¯ Ø­ØµØµ Ù†Ø´Ø·Ø©</td></tr>";
    }
}

function toMin(time) { const [h, m] = time.split(':'); return parseInt(h) * 60 + parseInt(m); }
</script>
</body>
</html>