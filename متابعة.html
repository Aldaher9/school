<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <title>Ù…Ù†ØµØ© Ø§Ù„Ù‚Ø§Ø¦Ø¯ - Ø§Ù„Ø±Ø¨Ø· Ø§Ù„Ø°ÙƒÙŠ Ù„Ù„Ø¨ÙŠØ§Ù†Ø§Øª</title>
    <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;700&display=swap" rel="stylesheet">
    <style>
        :root { --primary: #1e3a5f; --accent: #e67e22; --success: #25d366; --bg: #f4f7f6; }
        * { font-family: 'Tajawal', sans-serif !important; box-sizing: border-box; }
        body { background: var(--bg); margin: 0; padding: 20px; color: #333; }
        .header { background: var(--primary); color: white; padding: 20px; border-radius: 12px; text-align: center; margin-bottom: 20px; }
        .upload-area { background: white; padding: 30px; border-radius: 15px; border: 3px dashed var(--primary); text-align: center; margin-bottom: 20px; }
        .controls { background: #fff; padding: 15px; border-radius: 10px; margin-bottom: 20px; display: flex; gap: 10px; flex-wrap: wrap; border: 1px solid #ddd; }
        .status-bar { display: flex; justify-content: space-between; align-items: center; background: white; padding: 15px; border-radius: 10px; margin-bottom: 20px; border-right: 5px solid var(--accent); }
        table { width: 100%; border-collapse: collapse; background: white; border-radius: 12px; overflow: hidden; }
        th { background: #f1f4f6; padding: 15px; border-bottom: 2px solid #eee; }
        td { padding: 12px; border-bottom: 1px solid #eee; text-align: center; }
        .btn { border: none; padding: 10px 15px; border-radius: 6px; cursor: pointer; font-weight: bold; transition: 0.2s; }
        .wa-btn { background: var(--success); color: white; text-decoration: none; font-size: 0.85rem; }
        .sim-btn { background: #8e44ad; color: white; }
        .export-btn { background: #2c3e50; color: white; }
        .import-btn { background: #27ae60; color: white; cursor: pointer; display: inline-block; }
        .reset-btn { background: #e74c3c; color: white; }
        .badge { background: var(--accent); color: white; padding: 4px 10px; border-radius: 15px; font-size: 0.9rem; }
        .hidden { display: none; }
        .hint { font-size: 0.85rem; color: #666; margin-top: 5px; }
    </style>
</head>
<body>

<div class="header">
    <h2 style="margin:0;">ğŸ“ Ù…Ù†ØµØ© Ø§Ù„Ù‚Ø§Ø¦Ø¯ Ø§Ù„Ø°ÙƒÙŠØ©</h2>
    <p style="margin:5px 0 0 0;">Ù†Ø¸Ø§Ù… Ø§Ø³ØªØ®Ø±Ø§Ø¬ ÙˆØªØµØ¯ÙŠØ± Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø¹Ù„Ù…ÙŠÙ† Ù…Ù† Ø§Ù„Ø¬Ø¯ÙˆÙ„</p>
</div>

<div id="uploadContainer" class="upload-area">
    <h3>Ø®Ø·ÙˆØ© 1: Ø§Ø±ÙØ¹ Ù…Ù„Ù Ø§Ù„Ø¬Ø¯ÙˆÙ„ (time1.xml)</h3>
    <input type="file" id="xmlInput" accept=".xml" onchange="processAndSave(this)">
    <p class="hint">Ø³ÙŠÙ‚ÙˆÙ… Ø§Ù„Ù†Ø¸Ø§Ù… ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹ Ø¨Ø­ØµØ± Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…Ø¹Ù„Ù…ÙŠÙ† Ø§Ù„Ù…ÙˆØ¬ÙˆØ¯ÙŠÙ† ÙÙŠ Ø§Ù„Ù…Ù„Ù</p>
</div>

<div id="dashboard" class="hidden">
    <div class="controls">
        <button class="btn sim-btn" onclick="activateSimulation()">ğŸ² Ù…Ø­Ø§ÙƒØ§Ø© ÙˆÙ‚Øª</button>
        
        <button class="btn export-btn" onclick="exportTeachersToCSV()">ğŸ“Š ØªØµØ¯ÙŠØ± Ù‚Ø§Ø¦Ù…Ø© Ù…Ø¹Ù„Ù…ÙŠÙ† Ø§Ù„Ø¬Ø¯ÙˆÙ„</button>
        
        <label class="btn import-btn">
            ğŸ“¥ Ø§Ø³ØªÙŠØ±Ø§Ø¯ Ø§Ù„Ø£Ø±Ù‚Ø§Ù… (Ø¨Ø¹Ø¯ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„)
            <input type="file" id="importInput" accept=".csv" style="display:none" onchange="importFromCSV(this)">
        </label>
        
        <button class="btn reset-btn" onclick="clearMemory()" style="margin-right: auto;">ğŸ—‘ï¸ Ù…Ø³Ø­ ÙˆØ¥Ø¹Ø§Ø¯Ø© Ø¶Ø¨Ø·</button>
    </div>

    <div class="status-bar">
        <div id="info">--</div>
        <div id="txtPeriod" style="font-weight: bold; color: var(--accent);">--</div>
    </div>

    <table>
        <thead>
            <tr>
                <th>Ø§Ù„ØµÙ</th>
                <th>Ø§Ù„Ù…Ø¹Ù„Ù…</th>
                <th>Ø§Ù„Ù…Ø§Ø¯Ø©</th>
                <th>ØªÙˆØ§ØµÙ„ ÙˆØ§ØªØ³Ø§Ø¨</th>
            </tr>
        </thead>
        <tbody id="tableBody"></tbody>
    </table>
</div>

<script>
// ØªØ®Ø²ÙŠÙ† Ø§Ù„Ø£Ø±Ù‚Ø§Ù… (ÙŠØªÙ… ØªØ­Ø¯ÙŠØ«Ù‡Ø§ Ø¨Ø§Ù„Ø§Ø³ØªÙŠØ±Ø§Ø¯)
let teacherPhones = {};
let db = { teachers: {}, classes: {}, subjects: {}, lessons: [], periods: [] };
let simulationActive = false;
let simDay, simTime;

window.onload = function() {
    const savedTable = localStorage.getItem('schoolTableData');
    const savedPhones = localStorage.getItem('teacherPhonesData');
    if (savedPhones) teacherPhones = JSON.parse(savedPhones);
    if (savedTable) { db = JSON.parse(savedTable); showDashboard(); }
};

// --- ÙˆØ¸ÙŠÙØ© Ø§Ù„ØªØµØ¯ÙŠØ±: ØªØ¹ØªÙ…Ø¯ Ø¹Ù„Ù‰ Ø§Ù„Ù…Ø¹Ù„Ù…ÙŠÙ† Ø§Ù„Ù…Ø³ØªØ®Ø±Ø¬ÙŠÙ† Ù…Ù† Ù…Ù„Ù Ø§Ù„Ù€ XML Ø§Ù„Ù…Ø±ÙÙˆØ¹ ---
function exportTeachersToCSV() {
    if (Object.keys(db.teachers).length === 0) {
        alert("ÙŠØ±Ø¬Ù‰ Ø±ÙØ¹ Ù…Ù„Ù Ø§Ù„Ø¬Ø¯ÙˆÙ„ Ø£ÙˆÙ„Ø§Ù‹ Ù„Ø§Ø³ØªØ®Ø±Ø§Ø¬ Ø£Ø³Ù…Ø§Ø¡ Ø§Ù„Ù…Ø¹Ù„Ù…ÙŠÙ†!");
        return;
    }

    let csvContent = "\ufeff"; // BOM Ù„Ø¶Ù…Ø§Ù† Ø§Ù„Ù„ØºØ© Ø§Ù„Ø¹Ø±Ø¨ÙŠØ© ÙÙŠ Ø¥ÙƒØ³Ù„
    csvContent += "Ø§Ø³Ù… Ø§Ù„Ù…Ø¹Ù„Ù…,Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ\n"; 

    // Ø§Ø³ØªØ®Ø±Ø§Ø¬ ÙƒØ§ÙØ© Ø§Ù„Ù…Ø¹Ù„Ù…ÙŠÙ† Ø§Ù„ÙØ±ÙŠØ¯ÙŠÙ† Ù…Ù† Ù‚Ø§Ø¹Ø¯Ø© Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¬Ø¯ÙˆÙ„
    for (let id in db.teachers) {
        let name = db.teachers[id];
        let phone = teacherPhones[name] || ""; // Ø¥Ø°Ø§ ÙƒØ§Ù† Ø§Ù„Ø±Ù‚Ù… Ù…Ø®Ø²Ù†Ø§Ù‹ Ù…Ø³Ø¨Ù‚Ø§Ù‹ ÙŠØ¸Ù‡Ø±ØŒ ÙˆØ¥Ù„Ø§ ÙŠØªØ±Ùƒ ÙØ§Ø±ØºØ§Ù‹
        csvContent += `"${name}","${phone}"\n`;
    }

    const blob = new Blob([csvContent], { type: "text/csv;charset=utf-8;" });
    const url = URL.createObjectURL(blob);
    const link = document.createElement("a");
    link.href = url;
    link.download = "Ù‚Ø§Ø¦Ù…Ø©_Ù…Ø¹Ù„Ù…ÙŠÙ†_Ø§Ù„Ù…Ø¯Ø±Ø³Ø©.csv";
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
}

// --- ÙˆØ¸ÙŠÙØ© Ø§Ù„Ø§Ø³ØªÙŠØ±Ø§Ø¯: Ù„ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø£Ø±Ù‚Ø§Ù… ÙÙŠ Ø§Ù„Ù…ØªØµÙØ­ ---
function importFromCSV(input) {
    const file = input.files[0];
    if (!file) return;
    const reader = new FileReader();
    reader.onload = function(e) {
        const text = e.target.result;
        const rows = text.split('\n');
        let updated = false;
        
        rows.forEach((row, index) => {
            if (index === 0 || row.trim() === "") return;
            // Ø§Ù„ØªØ¹Ø§Ù…Ù„ Ù…Ø¹ Ø¹Ù„Ø§Ù…Ø§Øª Ø§Ù„ØªÙ†ØµÙŠØµ Ø§Ù„ØªÙŠ Ù‚Ø¯ ÙŠØ¶ÙŠÙÙ‡Ø§ Ø¥ÙƒØ³Ù„
            const columns = row.split(',').map(col => col.replace(/"/g, '').trim());
            if (columns.length >= 2) {
                const name = columns[0];
                const phone = columns[1];
                if (name) {
                    teacherPhones[name] = phone;
                    updated = true;
                }
            }
        });

        if (updated) {
            localStorage.setItem('teacherPhonesData', JSON.stringify(teacherPhones));
            alert("ØªÙ… ØªØ­Ø¯ÙŠØ« Ø£Ø±Ù‚Ø§Ù… Ø§Ù„Ù‡ÙˆØ§ØªÙ Ø¨Ù†Ø¬Ø§Ø­ âœ…");
            update();
        }
    };
    reader.readAsText(file);
}

function processAndSave(input) {
    if (!input.files[0]) return;
    const reader = new FileReader();
    reader.readAsText(input.files[0], "windows-1256");
    reader.onload = function(e) {
        const xml = new DOMParser().parseFromString(e.target.result, "text/xml");
        db.teachers = {}; // ØªØµÙÙŠØ± Ø§Ù„Ù‚Ø¯ÙŠÙ…
        db.periods = [];
        
        Array.from(xml.getElementsByTagName('teacher')).forEach(t => db.teachers[t.getAttribute('id')] = t.getAttribute('name'));
        Array.from(xml.getElementsByTagName('class')).forEach(c => db.classes[c.getAttribute('id')] = c.getAttribute('short'));
        Array.from(xml.getElementsByTagName('subject')).forEach(s => db.subjects[s.getAttribute('id')] = s.getAttribute('name'));
        Array.from(xml.getElementsByTagName('period')).forEach(p => db.periods.push({id: p.getAttribute('period'), s: p.getAttribute('starttime'), e: p.getAttribute('endtime')}));
        db.lessons = Array.from(xml.getElementsByTagName('TimeTableSchedule')).map(l => ({
            d: l.getAttribute('DayID'), p: l.getAttribute('Period'), c: l.getAttribute('ClassID'), t: l.getAttribute('TeacherID'), s: l.getAttribute('SubjectGradeID')
        }));
        
        localStorage.setItem('schoolTableData', JSON.stringify(db));
        showDashboard();
    };
}

function showDashboard() {
    document.getElementById('uploadContainer').classList.add('hidden');
    document.getElementById('dashboard').classList.remove('hidden');
    update();
    setInterval(update, 15000);
}

function activateSimulation() {
    simulationActive = true;
    simDay = Math.floor(Math.random() * 5) + 1;
    simTime = db.periods[Math.floor(Math.random() * db.periods.length)].s;
    update();
}

function clearMemory() {
    if(confirm("Ø³ÙŠØªÙ… Ù…Ø³Ø­ ÙƒÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø³Ø¬Ù„Ø©ØŒ Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ØŸ")) {
        localStorage.clear();
        location.reload();
    }
}

function update() {
    const now = new Date();
    const daysArr = ["Ø§Ù„Ø£Ø­Ø¯", "Ø§Ù„Ø¥Ø«Ù†ÙŠÙ†", "Ø§Ù„Ø«Ù„Ø§Ø«Ø§Ø¡", "Ø§Ù„Ø£Ø±Ø¨Ø¹Ø§Ø¡", "Ø§Ù„Ø®Ù…ÙŠØ³", "Ø§Ù„Ø¬Ù…Ø¹Ø©", "Ø§Ù„Ø³Ø¨Øª"];
    let d = simulationActive ? simDay : (now.getDay() === 0 ? 1 : now.getDay() + 1);
    let t = simulationActive ? simTime : now.getHours() + ":" + now.getMinutes().toString().padStart(2, '0');
    
    document.getElementById('info').innerText = daysArr[simulationActive ? (simDay==1?0:simDay-1) : now.getDay()] + " | " + t;

    const p = db.periods.find(p => { 
        const cur = toMin(t), s = toMin(p.s), e = toMin(p.e); 
        return cur >= s && cur <= e; 
    });

    const tbody = document.getElementById('tableBody');
    if (p) {
        document.getElementById('txtPeriod').innerText = "Ø§Ù„Ø­ØµØ©: " + p.id;
        const current = db.lessons.filter(l => l.d == d && l.p == p.id).sort((a,b) => (db.classes[a.c]||"").localeCompare(db.classes[b.c]||"", 'ar', {numeric:true}));
        tbody.innerHTML = current.map(l => {
            let name = db.teachers[l.t];
            let phone = teacherPhones[name] || "";
            // Ù…Ø¹Ø§Ù„Ø¬Ø© Ø®Ø§ØµØ© Ù„Ø£Ø³Ù…Ø§Ø¡ Ù…Ø­Ø¯Ø¯Ø©
            let chatName = (name === "Ø³ Ø±ÙŠØ§Ø¶ÙŠØ§Øª" || name === "ÙˆØ³ Ø±ÙŠØ§Ø¶ÙŠØ§Øª") ? "Ø£Ø­Ù…Ø¯ Ø¹Ø¨Ø¯Ø§Ù„ØªÙˆØ§Ø¨" : name;
            let msg = `Ø§Ù„Ø£Ø³ØªØ§Ø°/ ${chatName}\nÙ†Ø°ÙƒØ±ÙƒÙ… Ø¨Ø­ØµØªÙƒÙ…:\n- Ø§Ù„Ø­ØµØ©: (${p.id})\n- Ø§Ù„ØµÙ: (${db.classes[l.c]})\n- Ø§Ù„Ù…Ø§Ø¯Ø©: (${db.subjects[l.s]})`;
            return `<tr>
                <td><span class="badge">${db.classes[l.c]}</span></td>
                <td><b>${name}</b></td>
                <td>${db.subjects[l.s]}</td>
                <td>${phone ? `<a href="https://wa.me/${phone}?text=${encodeURIComponent(msg)}" target="_blank" class="wa-btn btn">ğŸ“² Ù…Ø±Ø§Ø³Ù„Ø©</a>` : '<span style="color:#999">Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø±Ù‚Ù…</span>'}</td>
            </tr>`;
        }).join('');
    } else {
        document.getElementById('txtPeriod').innerText = "Ø®Ø§Ø±Ø¬ Ø§Ù„Ø¯ÙˆØ§Ù…";
        tbody.innerHTML = "<tr><td colspan='4' style='padding:40px'>Ø§Ø±ÙØ¹ Ø§Ù„Ù…Ù„Ù Ø£Ùˆ Ø§Ø³ØªØ®Ø¯Ù… Ø§Ù„Ù…Ø­Ø§ÙƒØ§Ø©</td></tr>";
    }
}

function toMin(time) { const [h, m] = time.split(':'); return parseInt(h) * 60 + parseInt(m); }
</script>
</body>
</html>