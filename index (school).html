<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <title>Ù…Ù†ØµØ© Ø§Ù„Ù‚Ø§Ø¦Ø¯ - Ù†Ø¸Ø§Ù… Ø§Ù„Ù…ØªØ§Ø¨Ø¹Ø© ÙˆØ§Ù„Ù…Ø­Ø§ÙƒØ§Ø©</title>
    <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;700&display=swap" rel="stylesheet">
    <style>
        :root { --primary: #1e3a5f; --accent: #e67e22; --success: #25d366; --bg: #f4f7f6; }
        * { font-family: 'Tajawal', sans-serif !important; box-sizing: border-box; }
        body { background: var(--bg); margin: 0; padding: 20px; color: #333; }
        .header { background: var(--primary); color: white; padding: 20px; border-radius: 12px; text-align: center; margin-bottom: 20px; }
        .upload-area { background: white; padding: 30px; border-radius: 15px; border: 3px dashed var(--primary); text-align: center; margin-bottom: 20px; }
        .status-bar { display: flex; justify-content: space-between; align-items: center; background: white; padding: 15px; border-radius: 10px; margin-bottom: 20px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); border-right: 5px solid var(--accent); }
        .controls { background: #fff; padding: 15px; border-radius: 10px; margin-bottom: 20px; display: flex; gap: 10px; align-items: center; border: 1px solid #ddd; }
        table { width: 100%; border-collapse: collapse; background: white; border-radius: 12px; overflow: hidden; }
        th { background: #f1f4f6; padding: 15px; border-bottom: 2px solid #eee; }
        td { padding: 12px; border-bottom: 1px solid #eee; text-align: center; }
        .btn { border: none; padding: 8px 15px; border-radius: 5px; cursor: pointer; font-weight: bold; }
        .wa-btn { background: var(--success); color: white; text-decoration: none; font-size: 0.85rem; }
        .sim-btn { background: #8e44ad; color: white; }
        .reset-btn { background: #e74c3c; color: white; }
        .real-btn { background: #2c3e50; color: white; }
        .badge { background: var(--accent); color: white; padding: 4px 10px; border-radius: 15px; font-size: 0.9rem; }
        .hidden { display: none; }
        .mode-indicator { font-weight: bold; padding: 5px 10px; border-radius: 5px; }
    </style>
</head>
<body>

<div class="header">
    <h2 style="margin:0;">ğŸ“ Ù…Ù†ØµØ© Ø§Ù„Ù‚Ø§Ø¦Ø¯ Ø§Ù„Ø°ÙƒÙŠØ©</h2>
</div>

<div id="uploadContainer" class="upload-area">
    <h3>ÙŠØ±Ø¬Ù‰ Ø±ÙØ¹ Ù…Ù„Ù Ø§Ù„Ø¬Ø¯ÙˆÙ„ (time1.xml)</h3>
    <input type="file" id="xmlInput" accept=".xml" onchange="processAndSave(this)">
    <p>Ø³ÙŠØªÙ… Ø­ÙØ¸ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ÙÙŠ Ù…ØªØµÙØ­Ùƒ Ø¨Ø´ÙƒÙ„ Ø¯Ø§Ø¦Ù…</p>
</div>

<div id="dashboard" class="hidden">
    <div class="controls">
        <strong>âš™ï¸ Ø£Ø¯ÙˆØ§Øª Ø§Ù„ÙØ­Øµ:</strong>
        <button class="btn sim-btn" onclick="activateSimulation()">ğŸ² ØªØ´ØºÙŠÙ„ Ø§Ù„Ù…Ø­Ø§ÙƒØ§Ø©</button>
        <button class="btn real-btn" onclick="activateRealTime()">â±ï¸ Ø§Ù„ÙˆÙ‚Øª Ø§Ù„ÙØ¹Ù„ÙŠ</button>
        <button class="btn reset-btn" onclick="clearMemory()" style="margin-right: auto;">ğŸ—‘ï¸ ØªØºÙŠÙŠØ± Ø§Ù„Ù…Ù„Ù</button>
    </div>

    <div class="status-bar">
        <div id="info">--</div>
        <div id="txtPeriod" style="font-weight: bold; color: var(--accent);">--</div>
        <div id="modeTag" class="mode-indicator" style="background: #ecf0f1;">Ø§Ù„ÙˆÙ‚Øª Ø§Ù„ÙØ¹Ù„ÙŠ</div>
    </div>

    <table>
        <thead>
            <tr>
                <th>Ø§Ù„ØµÙ</th>
                <th>Ø§Ù„Ù…Ø¹Ù„Ù…</th>
                <th>Ø§Ù„Ù…Ø§Ø¯Ø©</th>
                <th>ØªÙˆØ§ØµÙ„ ÙˆØ§ØªØ³Ø§Ø¨</th>
            </tr>
        </thead>
        <tbody id="tableBody"></tbody>
    </table>
</div>

<script>
// Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø¯Ù…Ø¬Ø© Ù„Ù„Ù‡ÙˆØ§ØªÙ
const teacherDirectory = {
    "Ø£Ø­Ù…Ø¯ Ø§Ù„Ø¨Ù„ÙˆØ´ÙŠ": "96892959789", "Ø£Ø­Ù…Ø¯ Ø¹Ø¨Ø¯Ø§Ù„ÙˆÙ‡Ø§Ø¨": "96890128035", "Ø£Ø­Ù…Ø¯ Ø¹ÙŠØ³Ù‰ Ø¬Ù…Ø¹Ù‡ Ø§Ù„Ø¨ÙˆØµØ§ÙÙŠ": "96892876386",
    "Ø§Ø­Ù…Ø¯ Ø³Ø§Ù„Ù… Ù…Ø­Ù…Ø¯ Ø§Ù„ØºÙ…Ø§Ø±Ù‰": "96895500478", "Ø§Ø­Ù…Ø¯ Ø¹Ø¨Ø¯Ø§Ù„ØªÙˆØ§Ø¨": "96876609518", "Ø§Ø­Ù…Ø¯ Ù…Ø­Ù…Ø¯ Ø¬Ù…Ø¹Ù‡ Ø§Ù„Ø¨ÙˆØµØ§ÙÙ‰": "96892923979",
    "Ø§ÙŠÙ‡Ø§Ø¨ Ø¹Ù„ÙŠ Ù…Ø­Ù…Ø¯ Ø§Ù„Ø³ÙŠØ¯": "96891606092", "Ø¨Ù„Ø¹Ø±Ø¨": "96897366148", "Ø­Ø§Ø±Ø« Ù…Ø­Ù…Ø¯ Ø§Ø­Ù…Ø¯ Ø§Ù„Ø¨Ø·Ø§Ø´Ù‰": "96893355596",
    "Ø­Ù…Ø¯ Ø§Ù„Ù…Ø´Ø±ÙÙŠ": "96890918714", "Ø®Ø§Ù„Ø¯ Ø§Ù„Ø¹Ù„ÙˆÙŠ": "96896326333", "Ø®Ø§Ù„Ø¯ Ø±Ø§Ø´Ø¯ Ø³Ø¹ÙŠØ¯ Ø§Ù„ØºÙ…Ø§Ø±Ù‰": "96899857755",
    "Ø±Ø§Ø´Ø¯ Ù†Ø§ØµØ± Ø±Ø§Ø´Ø¯ Ø§Ù„ÙˆÙ‡ÙŠØ¨Ù‰": "96899211393", "Ø³Ø§Ù„Ù… Ø®Ù…ÙŠØ³ Ø¬Ù…Ø¹Ù‡ Ø§Ù„Ø²Ù‡ÙŠÙ…Ù‰": "96899322745", "Ø³ÙŠÙ Ø§Ø­Ù…Ø¯ Ø³ÙŠÙ Ø§Ù„Ø¨Ø·Ø§Ø´Ù‰": "96898920818",
    "Ø³ Ø±ÙŠØ§Ø¶ÙŠØ§Øª": "96876609518", "ÙˆØ³ Ø±ÙŠØ§Ø¶ÙŠØ§Øª": "96876609518"
};

let db = { teachers: {}, classes: {}, subjects: {}, lessons: [], periods: [] };
let simulationActive = false;
let simDay, simTime;

window.onload = function() {
    const saved = localStorage.getItem('schoolTableData');
    if (saved) { db = JSON.parse(saved); showDashboard(); }
};

function processAndSave(input) {
    const reader = new FileReader();
    reader.readAsText(input.files[0], "windows-1256");
    reader.onload = function(e) {
        const xml = new DOMParser().parseFromString(e.target.result, "text/xml");
        Array.from(xml.getElementsByTagName('teacher')).forEach(t => db.teachers[t.getAttribute('id')] = t.getAttribute('name'));
        Array.from(xml.getElementsByTagName('class')).forEach(c => db.classes[c.getAttribute('id')] = c.getAttribute('short'));
        Array.from(xml.getElementsByTagName('subject')).forEach(s => db.subjects[s.getAttribute('id')] = s.getAttribute('name'));
        Array.from(xml.getElementsByTagName('period')).forEach(p => db.periods.push({id: p.getAttribute('period'), s: p.getAttribute('starttime'), e: p.getAttribute('endtime')}));
        db.lessons = Array.from(xml.getElementsByTagName('TimeTableSchedule')).map(l => ({
            d: l.getAttribute('DayID'), p: l.getAttribute('Period'), c: l.getAttribute('ClassID'), t: l.getAttribute('TeacherID'), s: l.getAttribute('SubjectGradeID')
        }));
        localStorage.setItem('schoolTableData', JSON.stringify(db));
        showDashboard();
    };
}

function showDashboard() {
    document.getElementById('uploadContainer').classList.add('hidden');
    document.getElementById('dashboard').classList.remove('hidden');
    update();
    setInterval(update, 10000);
}

// Ø¯Ø§Ù„Ø© ØªÙØ¹ÙŠÙ„ Ø§Ù„Ù…Ø­Ø§ÙƒØ§Ø© Ù„ØºØ±Ø¶ Ø§Ù„ÙØ­Øµ
function activateSimulation() {
    simulationActive = true;
    // Ø§Ø®ØªÙŠØ§Ø± ÙŠÙˆÙ… Ø¯Ø±Ø§Ø³ÙŠ Ø¹Ø´ÙˆØ§Ø¦ÙŠ (1-5) ÙˆØ­ØµØ© Ø¹Ø´ÙˆØ§Ø¦ÙŠØ© Ù…Ù† Ø§Ù„Ø¬Ø¯ÙˆÙ„
    simDay = Math.floor(Math.random() * 5) + 1;
    const randomPeriod = db.periods[Math.floor(Math.random() * db.periods.length)];
    simTime = randomPeriod.s;
    
    const modeTag = document.getElementById('modeTag');
    modeTag.innerText = "ÙˆØ¶Ø¹ Ø§Ù„Ù…Ø­Ø§ÙƒØ§Ø© Ù†Ø´Ø· ğŸ²";
    modeTag.style.background = "#8e44ad";
    modeTag.style.color = "white";
    update();
}

function activateRealTime() {
    simulationActive = false;
    const modeTag = document.getElementById('modeTag');
    modeTag.innerText = "Ø§Ù„ÙˆÙ‚Øª Ø§Ù„ÙØ¹Ù„ÙŠ â±ï¸";
    modeTag.style.background = "#ecf0f1";
    modeTag.style.color = "#333";
    update();
}

function clearMemory() {
    if(confirm("Ø³ÙŠØªÙ… Ø­Ø°Ù Ø§Ù„Ù…Ù„Ù Ø§Ù„Ø­Ø§Ù„ÙŠØŒ Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ØŸ")) {
        localStorage.removeItem('schoolTableData');
        location.reload();
    }
}

function update() {
    const now = new Date();
    const daysArr = ["Ø§Ù„Ø£Ø­Ø¯", "Ø§Ù„Ø¥Ø«Ù†ÙŠÙ†", "Ø§Ù„Ø«Ù„Ø§Ø«Ø§Ø¡", "Ø§Ù„Ø£Ø±Ø¨Ø¹Ø§Ø¡", "Ø§Ù„Ø®Ù…ÙŠØ³", "Ø§Ù„Ø¬Ù…Ø¹Ø©", "Ø§Ù„Ø³Ø¨Øª"];
    
    // ØªØ­Ø¯ÙŠØ¯ Ø§Ù„ÙŠÙˆÙ… ÙˆØ§Ù„ÙˆÙ‚Øª Ø¨Ù†Ø§Ø¡Ù‹ Ø¹Ù„Ù‰ Ø§Ù„ÙˆØ¶Ø¹ (Ø­Ù‚ÙŠÙ‚ÙŠ Ø£Ùˆ Ù…Ø­Ø§ÙƒØ§Ø©)
    let dayForLogic = simulationActive ? simDay : (now.getDay() === 0 ? 1 : now.getDay() + 1);
    let timeForLogic = simulationActive ? simTime : now.getHours() + ":" + now.getMinutes().toString().padStart(2, '0');
    let dayName = daysArr[simulationActive ? (simDay==1?0:simDay-1) : now.getDay()];

    document.getElementById('info').innerText = dayName + " | " + timeForLogic;

    const p = db.periods.find(p => { 
        const cur = toMin(timeForLogic), s = toMin(p.s), e = toMin(p.e); 
        return cur >= s && cur <= e; 
    });

    const tbody = document.getElementById('tableBody');
    if (p) {
        document.getElementById('txtPeriod').innerText = "Ø§Ù„Ø­ØµØ©: " + p.id;
        const current = db.lessons.filter(l => l.d == dayForLogic && l.p == p.id)
            .sort((a, b) => (db.classes[a.c] || "").localeCompare(db.classes[b.c] || "", 'ar', {numeric: true}));
        
        tbody.innerHTML = current.map(l => {
            let name = db.teachers[l.t];
            let phone = teacherDirectory[name] || "";
            let chatName = (name === "Ø³ Ø±ÙŠØ§Ø¶ÙŠØ§Øª" || name === "ÙˆØ³ Ø±ÙŠØ§Ø¶ÙŠØ§Øª") ? "Ø£Ø­Ù…Ø¯ Ø¹Ø¨Ø¯Ø§Ù„ØªÙˆØ§Ø¨" : name;

            return `<tr>
                <td><span class="badge">${db.classes[l.c]}</span></td>
                <td><b>${name}</b></td>
                <td>${db.subjects[l.s]}</td>
                <td>${phone ? `<a href="https://wa.me/${phone}?text=${encodeURIComponent('Ø§Ù„Ø£Ø³ØªØ§Ø°/ '+chatName+'.. Ù†Ø°ÙƒØ±ÙƒÙ… Ø¨Ø­ØµØªÙƒÙ… Ø§Ù„Ø­Ø§Ù„ÙŠØ©.')}" target="_blank" class="wa-btn btn">ğŸ“² Ù…Ø±Ø§Ø³Ù„Ø©</a>` : '---'}</td>
            </tr>`;
        }).join('');
    } else {
        document.getElementById('txtPeriod').innerText = "Ø®Ø§Ø±Ø¬ Ø§Ù„Ø¯ÙˆØ§Ù…";
        tbody.innerHTML = "<tr><td colspan='4' style='padding:40px'>Ù„Ø§ ØªÙˆØ¬Ø¯ Ø­ØµØµ ÙÙŠ Ù‡Ø°Ø§ Ø§Ù„ØªÙˆÙ‚ÙŠØª</td></tr>";
    }
}

function toMin(time) { const [h, m] = time.split(':'); return parseInt(h) * 60 + parseInt(m); }
</script>
</body>
</html>