<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <title>منصة مدير المدرسة - نظام الزيارات الفنية</title>
    <style>
        :root { --primary: #1a5f7a; --accent: #27ae60; --bg: #f4f7f6; }
        body { font-family: 'Segoe UI', sans-serif; background: var(--bg); margin: 0; padding: 20px; text-align: right; }
        .container { max-width: 900px; margin: auto; background: white; padding: 30px; border-radius: 15px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); }
        .header { text-align: center; color: var(--primary); border-bottom: 2px solid #eee; margin-bottom: 25px; }
        .form-group { margin-bottom: 15px; }
        input[type="text"] { width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 5px; }
        table { width: 100%; border-collapse: collapse; margin: 20px 0; }
        th { background: var(--primary); color: white; padding: 12px; }
        td { padding: 10px; border-bottom: 1px solid #eee; text-align: center; }
        .btn-main { width: 100%; padding: 15px; background: var(--accent); color: white; border: none; border-radius: 8px; font-size: 1.1rem; cursor: pointer; font-weight: bold; }
        #reportOutput { display: none; margin-top: 30px; padding: 25px; border: 2px solid var(--primary); border-radius: 10px; line-height: 1.6; }
        .print-btn { background: #333; margin-top: 10px; }
    </style>
</head>
<body>

<div class="container">
    <div class="header"><h2>منظومة التقارير الإشرافية الذكية</h2></div>

    <div class="card" style="background:#f0f7f9; padding:15px; border-radius:8px; margin-bottom:20px;">
        <h4>1. رفع قاعدة العبارات الجديدة</h4>
        <input type="file" id="jsonInput" accept=".json" onchange="loadDatabase(event)">
        <p id="status" style="color:green; font-size:0.9rem;"></p>
    </div>

    <div class="form-group">
        <label>اسم المعلم:</label>
        <input type="text" id="tName" placeholder="أدخل اسم المعلم">
    </div>

    <table id="evalTable" style="display:none">
        <thead>
            <tr>
                <th style="text-align: right;">المعيار / البند</th>
                <th>التقدير</th>
            </tr>
        </thead>
        <tbody id="tableBody"></tbody>
    </table>

    <button id="genBtn" class="btn-main" style="display:none" onclick="generateProfessionalReport()">توليد التقرير المختصر</button>

    <div id="reportOutput">
        <div id="reportContent"></div>
        <button class="btn-main print-btn" onclick="window.print()">طباعة التقرير (PDF)</button>
    </div>
</div>

<script>
    let phrases = [];

    function loadDatabase(event) {
        const file = event.target.files[0];
        const reader = new FileReader();
        reader.onload = function(e) {
            try {
                phrases = JSON.parse(e.target.result);
                renderTable();
                document.getElementById('status').innerText = "✅ تم ربط قاعدة العبارات بنجاح.";
            } catch (err) { alert("خطأ في قراءة الملف."); }
        };
        reader.readAsText(file);
    }

    function renderTable() {
        const tbody = document.getElementById('tableBody');
        tbody.innerHTML = '';
        
        // استخراج البنود غير الفارغة فقط
        const criteria = phrases.filter(item => item["المعيار / البند"] && item["المعيار / البند"].trim() !== "");
        
        criteria.forEach((item, index) => {
            tbody.innerHTML += `
                <tr>
                    <td style="text-align: right;">${item["المعيار / البند"]}</td>
                    <td>
                        <select class="score-sel" data-criteria="${item["المعيار / البند"]}">
                            <option value="1">1- متميز</option>
                            <option value="2">2- جيد جداً</option>
                            <option value="3" selected>3- ملائم</option>
                            <option value="4">4- يحتاج تحسين</option>
                            <option value="5">5- ضعيف</option>
                        </select>
                    </td>
                </tr>`;
        });
        document.getElementById('evalTable').style.display = 'table';
        document.getElementById('genBtn').style.display = 'block';
    }

    function generateProfessionalReport() {
        const teacher = document.getElementById('tName').value || "المعلم";
        const selects = document.querySelectorAll('.score-sel');
        let strengths = [], weaknesses = [], finalRecs = [];

        selects.forEach(sel => {
            const score = parseInt(sel.value);
            const crit = sel.dataset.criteria;
            
            // البحث عن العبارة المطابقة في الملف الجديد
            const match = phrases.find(p => {
                const isMatch = (p["المعيار / البند"] === crit || (p["المعيار / البند"] === "" && phrases.indexOf(p) > 0));
                return isMatch && p["الحكم"].includes(`(${score})`);
            });

            if (match) {
                const desc = match["الوصف السلوكي لجوانب الإجادة / أولويات التطوير"];
                const rec = match["التوصيات"];
                if (score <= 2) strengths.push(desc);
                if (score >= 4) weaknesses.push(desc);
                if (rec) finalRecs.push(rec);
            }
        });

        // بناء التقرير حسب تعليمات "المحضر المختصر جداً"
        let html = `<div style="text-align:center;"><h3>تقرير زيارة إشرافية</h3></div>`;
        html += `<p>نتقدم بوافر الشكر والتقدير للمعلم الفاضل/ <b>${teacher}</b> على ما قدمه من أداء ملموس وجهود طيبة خلال الحصة الدراسية، سعياً نحو تجويد العملية التعليمية، ونوجز مخرجات الزيارة فيما يلي:</p>`;
        
        html += `<ol>`;
        // 1. جوانب الإجادة (أفضل 3)
        html += `<li><b>جوانب الإجادة:</b> ${strengths.slice(0, 3).join(' - ')}</li><br>`;
        
        // 2. جوانب التطوير
        html += `<li><b>جوانب التطوير:</b> ${weaknesses.length > 0 ? weaknesses.slice(0, 2).join(' - ') : 'الأداء مستقر وفق المعايير المطلوبة.'}</li><br>`;
        
        // 3. التوصيات (بناءً على طلبك: نوصيه بالتالي)
        html += `<li><b>التوصيات:</b> نوصي المعلم بالاستمرار في العطاء، و ${finalRecs.slice(0, 2).join('، و ')}.</li>`;
        html += `</ol>`;

        const out = document.getElementById('reportOutput');
        document.getElementById('reportContent').innerHTML = html;
        out.style.display = 'block';
        window.scrollTo(0, document.body.scrollHeight);
    }
</script>
</body>
</html>
